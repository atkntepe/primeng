name: Issue Triage Bot

on:
  issues:
    types: [opened]

  workflow_dispatch:
    inputs:
      process_backlog:
        description: 'Process untriaged issues'
        type: boolean
        default: true
      max_issues:
        description: 'Maximum issues to process'
        type: number
        default: 50
      dry_run:
        description: 'Dry run (no labels/comments applied)'
        type: boolean
        default: false

permissions:
  issues: write
  contents: read

jobs:
  triage:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci
        working-directory: .github/scripts

      - name: Run Issue Triage
        uses: actions/github-script@v7
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          DRY_RUN: ${{ inputs.dry_run || 'false' }}
        with:
          script: |
            const { triageIssue, triageBacklog } = require('./.github/scripts/triage-issue.js');

            if (context.eventName === 'workflow_dispatch' && '${{ inputs.process_backlog }}' === 'true') {
              await triageBacklog(github, context, {
                maxIssues: parseInt('${{ inputs.max_issues }}') || 50,
                dryRun: process.env.DRY_RUN === 'true'
              });
            } else if (context.eventName === 'issues') {
              await triageIssue(github, context, context.payload.issue, {
                dryRun: process.env.DRY_RUN === 'true'
              });
            }
